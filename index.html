<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EnergyPro Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { margin:0; font-family:Segoe UI; background:#f4f6f9 }
.sidebar {
  width:220px; height:100vh; position:fixed;
  background:#0b2a5a; color:#fff
}
.sidebar h2 { padding:20px }
.sidebar a {
  display:block; padding:14px 20px;
  color:#fff; text-decoration:none; cursor:pointer
}
.sidebar a.active, .sidebar a:hover { background:#1c4b9c }
.main { margin-left:220px; padding:20px }

.cards {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:15px
}
.card {
  background:#fff; padding:20px; border-radius:10px;
  box-shadow:0 4px 8px rgba(0,0,0,.05)
}
.card h4 { margin:0; color:#777 }
.value { font-size:28px; margin-top:10px }

.status {
  display:grid; grid-template-columns:1fr 1fr;
  gap:20px; margin-top:20px
}
.dot {
  width:10px; height:10px; border-radius:50%;
  display:inline-block; margin-right:8px; background:red
}

button {
  padding:12px; font-size:16px; border:none;
  border-radius:6px; cursor:pointer
}
.on { background:#2ecc71; color:#fff }
.off { background:#e74c3c; color:#fff }
.disabled { opacity:.4; cursor:not-allowed }
</style>
</head>

<body>

<div class="sidebar">
  <h2>âš¡ EnergyPro</h2>
  <a id="navDashboard" class="active">Dashboard</a>
  <a id="navReports">Reports</a>
</div>

<div class="main">

<!-- ================= DASHBOARD ================= -->
<div id="page-dashboard">

<h1>Energy Dashboard</h1>
<p>Real-time prepaid energy monitoring</p>

<div class="cards">
  <div class="card"><h4>Balance</h4><div class="value"><span id="credit">0</span> kWh</div></div>
  <div class="card"><h4>Voltage</h4><div class="value"><span id="voltage">0</span> V</div></div>
  <div class="card"><h4>Current</h4><div class="value"><span id="current">0</span> A</div></div>
  <div class="card"><h4>Power</h4><div class="value"><span id="power">0</span> W</div></div>
  <div class="card"><h4>Energy</h4><div class="value"><span id="energy">0</span> kWh</div></div>
</div>

<div class="status">
  <div class="card">
    <h3>Status</h3>
    <p><span id="powerDot" class="dot"></span> Power:
      <b id="powerStatus">OFF</b></p>
  </div>

  <div class="card">
    <h3>Quick Actions</h3>
    <button id="onBtn" class="on">Power ON</button>
    <button id="offBtn" class="off">Power OFF</button>
  </div>
</div>

</div>

<!-- ================= REPORTS ================= -->
<div id="page-reports" style="display:none">
<h1>Energy Reports</h1>

<div class="cards">
  <div class="card">
    <h4>Live Power (W)</h4>
    <canvas id="powerChart"></canvas>
  </div>
  <div class="card">
    <h4>Energy Consumption (kWh)</h4>
    <canvas id="energyChart"></canvas>
  </div>
</div>
</div>

</div>

<script>
/* ðŸ” Firebase */
firebase.initializeApp({
  apiKey: "AIzaSyDPy9D_J7YNrQFTZ_sC3w71S5iYIKRWr8g",
  databaseURL: "https://energymeter-6e176-default-rtdb.firebaseio.com/"
});
const db = firebase.database();

/* ðŸ”˜ Elements */
const voltage = document.getElementById("voltage");
const current = document.getElementById("current");
const power = document.getElementById("power");
const energy = document.getElementById("energy");
const credit = document.getElementById("credit");
const powerStatus = document.getElementById("powerStatus");
const powerDot = document.getElementById("powerDot");
const onBtn = document.getElementById("onBtn");
const offBtn = document.getElementById("offBtn");

/* ðŸ” Navigation */
const pages = {
  navDashboard: "page-dashboard",
  navReports: "page-reports"
};

Object.keys(pages).forEach(id => {
  document.getElementById(id).onclick = () => {
    Object.values(pages).forEach(p =>
      document.getElementById(p).style.display = "none");
    document.querySelectorAll(".sidebar a")
      .forEach(a => a.classList.remove("active"));
    document.getElementById(pages[id]).style.display = "block";
    document.getElementById(id).classList.add("active");
  };
});

/* ðŸ”˜ Relay Control */
onBtn.onclick = () => db.ref("/power_meter/relay_request").set(true);
offBtn.onclick = () => db.ref("/power_meter/relay_request").set(false);

/* ðŸ“Š Charts */
const powerChart = new Chart(powerChartCanvas = document.getElementById("powerChart"), {
  type:"line",
  data:{ labels:[], datasets:[{label:"Power (W)", data:[], tension:.4}] },
  options:{ animation:false }
});

const energyChart = new Chart(energyChartCanvas = document.getElementById("energyChart"), {
  type:"line",
  data:{ labels:[], datasets:[{label:"Energy (kWh)", data:[], tension:.4}] },
  options:{ animation:false }
});

/* â˜ï¸ Hourly Logger */
let lastHour = null;
let hourStartEnergy = null;

/* ðŸ”„ Live Data */
db.ref("/power_meter").on("value", s => {
  const d = s.val();
  if (!d) return;

  voltage.innerText = d.voltage?.toFixed(1) || 0;
  current.innerText = d.current?.toFixed(3) || 0;
  power.innerText = d.active_power?.toFixed(1) || 0;
  energy.innerText = d.energy?.toFixed(3) || 0;
  credit.innerText = d.credit_kwh?.toFixed(2) || 0;

  if (d.relay_state) {
    powerStatus.innerText = "ON";
    powerDot.style.background = "green";
  } else {
    powerStatus.innerText = "OFF";
    powerDot.style.background = "red";
  }

  const t = new Date().toLocaleTimeString();
  powerChart.data.labels.push(t);
  powerChart.data.datasets[0].data.push(d.active_power || 0);
  energyChart.data.labels.push(t);
  energyChart.data.datasets[0].data.push(d.energy || 0);

  if (powerChart.data.labels.length > 20) {
    powerChart.data.labels.shift();
    powerChart.data.datasets[0].data.shift();
    energyChart.data.labels.shift();
    energyChart.data.datasets[0].data.shift();
  }

  powerChart.update();
  energyChart.update();

  /* â˜ï¸ HOURLY LOGGING */
  const now = new Date();
  const dateKey = now.toISOString().split("T")[0];
  const hour = now.getHours();

  if (lastHour === null) {
    lastHour = hour;
    hourStartEnergy = d.energy;
    return;
  }

  if (hour !== lastHour) {
    const used = d.energy - hourStartEnergy;
    if (used > 0) {
      db.ref(`/energy_logs/${dateKey}/${lastHour}`).set({
        energy_kwh: Number(used.toFixed(4)),
        timestamp: Date.now()
      });
    }
    lastHour = hour;
    hourStartEnergy = d.energy;
  }
});
</script>

</body>
</html>
