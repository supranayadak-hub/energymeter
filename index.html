<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EnergyPro Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { margin:0; font-family:Segoe UI; background:#f4f6f9 }
.sidebar {
  width:220px; height:100vh; position:fixed;
  background:#0b2a5a; color:#fff
}
.sidebar h2 { padding:20px }
.sidebar a {
  display:block; padding:14px 20px;
  color:#fff; text-decoration:none
}
.sidebar a.active, .sidebar a:hover { background:#1c4b9c }
.main { margin-left:220px; padding:20px }

.cards {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:15px
}
.card {
  background:#fff; padding:20px; border-radius:10px;
  box-shadow:0 4px 8px rgba(0,0,0,.05)
}
.card h4 { margin:0; color:#777 }
.value { font-size:28px; margin-top:10px }

.status {
  display:grid; grid-template-columns:1fr 1fr;
  gap:20px; margin-top:20px
}
.dot {
  width:10px; height:10px; background:green;
  border-radius:50%; display:inline-block; margin-right:8px
}

button {
  padding:12px; font-size:16px; border:none;
  border-radius:6px; cursor:pointer
}
.on { background:#2ecc71; color:#fff }
.off { background:#e74c3c; color:#fff }
.disabled { opacity:.4; cursor:not-allowed }
</style>
</head>

<body>

<div class="sidebar">
  <h2>âš¡ EnergyPro</h2>
  <a class="active">Dashboard</a>
  <a>Account</a>
  <a>Control</a>
  <a>Reports</a>
  <a>Settings</a>
</div>

<div class="main">
  <h1>Energy Dashboard</h1>
  <p>Real-time monitoring of your prepaid energy system</p>

  <!-- LIVE CARDS -->
  <div class="cards">
    <div class="card"><h4>Balance</h4><div class="value">â‚¹ <span id="credit">0</span></div></div>
    <div class="card"><h4>Voltage</h4><div class="value"><span id="voltage">0</span> V</div></div>
    <div class="card"><h4>Current</h4><div class="value"><span id="current">0</span> A</div></div>
    <div class="card"><h4>Active Power</h4><div class="value"><span id="power">0</span> W</div></div>
    <div class="card"><h4>Apparent Power</h4><div class="value"><span id="apparent">0</span> VA</div></div>
    <div class="card"><h4>Reactive Power</h4><div class="value"><span id="reactive">0</span> VAR</div></div>
    <div class="card"><h4>Frequency</h4><div class="value"><span id="freq">0</span> Hz</div></div>
    <div class="card"><h4>Power Factor</h4><div class="value"><span id="pf">0</span></div></div>
  </div>

  <!-- STATUS + CONTROLS -->
  <div class="status">
    <div class="card">
      <h3>System Status</h3>
      <p><span class="dot"></span> Power: <b id="powerStatus">OFF</b></p>
      <p><span class="dot"></span> Fault Status: OK</p>
      <p><span class="dot"></span> Theft Detection: OK</p>
      <p><span class="dot"></span> Energy: <b><span id="energy">0</span> kWh</b></p>
    </div>

    <div class="card">
      <h3>Quick Actions</h3>
      <button id="onBtn" class="on">Power ON</button>
      <button id="offBtn" class="off">Power OFF</button>
      <hr>
      <button class="on" onclick="openRecharge()">Recharge</button>
    </div>
  </div>
</div>

<!-- ðŸ”‹ RECHARGE POPUP -->
<div id="rechargeModal" style="
 display:none; position:fixed; inset:0;
 background:rgba(0,0,0,.5);
 align-items:center; justify-content:center">

  <div style="background:#fff; padding:25px;
   width:320px; border-radius:10px">
    <h3>Recharge Account</h3>

    <input id="amt" type="number" placeholder="Amount â‚¹"
     style="width:100%; padding:10px; margin:10px 0">

    <p>Tariff: â‚¹ <span id="tariff">0</span> / kWh</p>
    <p>You get: <b><span id="kwh">0</span> kWh</b></p>

    <button class="on" style="width:100%" onclick="doRecharge()">Recharge Now</button>
    <button class="off" style="width:100%; margin-top:8px"
     onclick="closeRecharge()">Cancel</button>
  </div>
</div>

<script>
/* ðŸ” FIREBASE CONFIG */
firebase.initializeApp({
  apiKey: "AIzaSyDPy9D_J7YNrQFTZ_sC3w71S5iYIKRWr8g",
  databaseURL: "https://energymeter-6e176-default-rtdb.firebaseio.com/"
});
const db = firebase.database();

/* ðŸ”„ LIVE DATA */
db.ref("/power_meter").on("value", s => {
  const d = s.val(); if (!d) return;

  voltage.innerText = d.voltage?.toFixed(1);
  current.innerText = d.current?.toFixed(3);
  power.innerText = d.active_power?.toFixed(1);
  apparent.innerText = d.apparent_power?.toFixed(2);
  reactive.innerText = d.reactive_power?.toFixed(2);
  freq.innerText = d.frequency?.toFixed(1);
  pf.innerText = d.pf?.toFixed(2);
  energy.innerText = d.energy?.toFixed(3);
  credit.innerText = d.credit_kwh?.toFixed(2);

  powerStatus.innerText = d.relay_state ? "ON" : "OFF";

  if (d.credit_kwh <= 0) {
    onBtn.disabled = true;
    onBtn.classList.add("disabled");
  } else {
    onBtn.disabled = false;
    onBtn.classList.remove("disabled");
  }
});

/* ðŸ”˜ RELAY */
onBtn.onclick = () => db.ref("/power_meter/relay_request").set(true);
offBtn.onclick = () => db.ref("/power_meter/relay_request").set(false);

/* ðŸ”‹ RECHARGE */
let tariffVal = 6.5;
db.ref("/tariff/price_per_kwh").on("value", s => {
  tariffVal = s.val() || 6.5;
  tariff.innerText = tariffVal;
});

function openRecharge(){ rechargeModal.style.display="flex"; }
function closeRecharge(){ rechargeModal.style.display="none"; }

amt.oninput = e => {
  kwh.innerText = e.target.value > 0
    ? (e.target.value / tariffVal).toFixed(3)
    : "0";
};

function doRecharge(){
  const rs = Number(amt.value);
  if (rs <= 0) return alert("Enter amount");

  const k = rs / tariffVal;

  db.ref("/power_meter/credit_kwh")
    .transaction(v => (v || 0) + k);

  db.ref("/power_meter/relay_request").set(true);

  db.ref("/recharge_logs").push({
    amount_rupees: rs,
    energy_kwh: k,
    timestamp: Date.now()
  });

  alert("Recharge successful!");
  closeRecharge();
}
</script>

</body>
</html>
