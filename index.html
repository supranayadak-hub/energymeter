<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EnergyPro Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;font-family:Segoe UI;background:#f4f6f9}
.sidebar{width:220px;height:100vh;position:fixed;background:#0b2a5a;color:#fff}
.sidebar h2{padding:20px}
.sidebar a{display:block;padding:14px 20px;color:#fff;cursor:pointer}
.sidebar a.active,.sidebar a:hover{background:#1c4b9c}
.main{margin-left:220px;padding:20px}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px}
.card{background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,.05)}
.card h4{margin:0;color:#777}
.value{font-size:26px;margin-top:8px}
.status{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:8px;background:red}
button{padding:12px;font-size:16px;border:none;border-radius:6px;cursor:pointer}
.on{background:#2ecc71;color:#fff}
.off{background:#e74c3c;color:#fff}
.disabled{opacity:.4;cursor:not-allowed}
</style>
</head>

<body>

<div class="sidebar">
  <h2>âš¡ EnergyPro</h2>
  <a class="active">Dashboard</a>
</div>

<div class="main">

<h1>Energy Dashboard</h1>

<div class="cards">
  <div class="card"><h4>Balance</h4><div class="value"><span id="credit">0</span> kWh</div></div>
  <div class="card"><h4>Voltage</h4><div class="value"><span id="voltage">0</span> V</div></div>
  <div class="card"><h4>Current</h4><div class="value"><span id="current">0</span> A</div></div>
  <div class="card"><h4>Active Power</h4><div class="value"><span id="active_power">0</span> W</div></div>
  <div class="card"><h4>Apparent Power</h4><div class="value"><span id="apparent_power">0</span> VA</div></div>
  <div class="card"><h4>Reactive Power</h4><div class="value"><span id="reactive_power">0</span> VAR</div></div>
  <div class="card"><h4>Frequency</h4><div class="value"><span id="frequency">0</span> Hz</div></div>
  <div class="card"><h4>Power Factor</h4><div class="value"><span id="pf">0</span></div></div>
  <div class="card"><h4>Energy</h4><div class="value"><span id="energy">0</span> kWh</div></div>
</div>

<div class="status">
  <div class="card">
    <h3>Status</h3>
    <p><span id="powerDot" class="dot"></span>
       Power: <b id="powerStatus">OFF</b></p>
  </div>

  <div class="card">
    <h3>Quick Actions</h3>
    <button id="onBtn" class="on">Power ON</button>
    <button id="offBtn" class="off">Power OFF</button>
    <hr>
    <button class="on" onclick="openRecharge()">Recharge</button>
  </div>
</div>

</div>

<!-- ðŸ”‹ RECHARGE -->
<div id="rechargeModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center">
<div style="background:#fff;padding:25px;width:300px;border-radius:10px">
<h3>Recharge</h3>
<input id="amt" type="number" placeholder="Amount â‚¹" style="width:100%;padding:10px">
<p>Tariff: â‚¹ <span id="tariff">6.5</span>/kWh</p>
<p>You get: <b><span id="kwh">0</span> kWh</b></p>
<button class="on" style="width:100%" onclick="doRecharge()">Recharge Now</button>
<button class="off" style="width:100%;margin-top:8px" onclick="closeRecharge()">Cancel</button>
</div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDPy9D_J7YNrQFTZ_sC3w71S5iYIKRWr8g",
  databaseURL:"https://energymeter-6e176-default-rtdb.firebaseio.com/"
});
const db=firebase.database();

/* Elements */
const ids=["voltage","current","active_power","apparent_power","reactive_power","frequency","pf","energy","credit"];
const el={};ids.forEach(i=>el[i]=document.getElementById(i));
const powerStatus=document.getElementById("powerStatus");
const powerDot=document.getElementById("powerDot");
const onBtn=document.getElementById("onBtn");
const offBtn=document.getElementById("offBtn");

/* Relay buttons */
onBtn.onclick=()=>db.ref("/power_meter/relay_request").set(true);
offBtn.onclick=()=>db.ref("/power_meter/relay_request").set(false);

/* Recharge */
let tariffVal=6.5;
amt.oninput=e=>kwh.innerText=(e.target.value/tariffVal||0).toFixed(3);
function openRecharge(){rechargeModal.style.display="flex";}
function closeRecharge(){rechargeModal.style.display="none";}
function doRecharge(){
 const rs=Number(amt.value);
 if(rs<=0)return alert("Enter amount");
 const k=rs/tariffVal;
 db.ref("/power_meter/credit_kwh").transaction(v=>(v||0)+k);
 alert("Recharge successful");
 closeRecharge();
}

/* Live data + AUTO DISABLE */
db.ref("/power_meter").on("value",s=>{
 const d=s.val(); if(!d)return;

 el.voltage.innerText=d.voltage?.toFixed(1);
 el.current.innerText=d.current?.toFixed(3);
 el.active_power.innerText=d.active_power?.toFixed(1);
 el.apparent_power.innerText=d.apparent_power?.toFixed(1);
 el.reactive_power.innerText=d.reactive_power?.toFixed(1);
 el.frequency.innerText=d.frequency?.toFixed(1);
 el.pf.innerText=d.pf?.toFixed(2);
 el.energy.innerText=d.energy?.toFixed(3);
 el.credit.innerText=d.credit_kwh?.toFixed(2);

 if(d.relay_state){
   powerStatus.innerText="ON";
   powerDot.style.background="green";
 }else{
   powerStatus.innerText="OFF";
   powerDot.style.background="red";
 }

 // ðŸ”’ AUTO DISABLE ON BUTTON
 if(d.credit_kwh<=0){
   onBtn.disabled=true;
   onBtn.classList.add("disabled");
 }else{
   onBtn.disabled=false;
   onBtn.classList.remove("disabled");
 }
});
</script>

</body>
</html>
